@* This is an authenticated page for viewing a student's grades.*@

@namespace Counter.Components
@using RazorConsole.Components
@inject NavigationManager Navigation
@using Spectre.Console
@using ShkoloClone.Services
@using ShkoloClone.Data
@using ShkoloClone.Models
@using ShkoloClone.Enums
@page "/Teacher/StudentGrades/{UserId:guid}/{StudentId:guid}"

@if (IsLoading)
{
    <Panel Title="Loading" Border="BoxBorder.Rounded" Expand="true">
        <Align Horizontal="HorizontalAlignment.Center" Vertical="VerticalAlignment.Middle">
            <Markup Content="Loading student information..." Foreground="@Color.Grey70" />
        </Align>
    </Panel>
}
else if (!IsAuthenticated)
{
    <Panel Title="Access Denied" Border="BoxBorder.Rounded" Expand="true">
        <Align Horizontal="HorizontalAlignment.Center" Vertical="VerticalAlignment.Middle">
            <Rows>
                <Markup Content="@ErrorMessage" Foreground="@Color.Red" />
                <Newline />
                <TextButton Content="Back to Home"
                            OnClick="ReturnToHome"
                            BackgroundColor="@Color.Green"
                            FocusedColor="@Color.LightGreen" />
            </Rows>
        </Align>
    </Panel>
}
else if (!HasRole(AppUserEnum.Teacher) && !HasRole(AppUserEnum.Admin))
{
    <Panel Title="Access Denied" Border="BoxBorder.Rounded" Expand="true">
        <Align Horizontal="HorizontalAlignment.Center" Vertical="VerticalAlignment.Middle">
            <Rows>
                <Markup Content="Only teachers and admins can access this page." Foreground="@Color.Red" />
                <Newline />
                <TextButton Content="Back to Dashboard"
                            OnClick="ReturnToDashboard"
                            BackgroundColor="@Color.Green"
                            FocusedColor="@Color.LightGreen" />
            </Rows>
        </Align>
    </Panel>
}
else if (Student == null)
{
    <Panel Title="Error" Border="BoxBorder.Rounded" Expand="true">
        <Align Horizontal="HorizontalAlignment.Center" Vertical="VerticalAlignment.Middle">
            <Rows>
                <Markup Content="Student not found." Foreground="@Color.Red" />
                <Newline />
                <TextButton Content="Back"
                            OnClick="ReturnToClasses"
                            BackgroundColor="@Color.Green"
                            FocusedColor="@Color.LightGreen" />
            </Rows>
        </Align>
    </Panel>
}
else
{
    <Figlet Content="Student Grades" />
    <Panel Title="@($"{Student.FirstName} {Student.LastName}'s Grades")" Border="BoxBorder.Rounded" Expand="true">
        <Align Horizontal="HorizontalAlignment.Center" Vertical="VerticalAlignment.Middle">
            <Rows>
                <Markup Content="@($"Student: {Student.FirstName} {Student.LastName}")" Foreground="@Color.Gold3_1" Decoration="Decoration.Bold" />
                <Newline />

                @{
                    var gradesBySubject = GetStudentService().GetStudentGradesBySubject(StudentId);
                }

                @if (gradesBySubject.Count == 0)
                {
                    <Markup Content="No grades found for this student." Foreground="@Color.Yellow" />
                }
                else
                {
                    <Grid Columns="2">
                        <Markup Content="Subject" Foreground="@Color.Gold3_1" Decoration="Decoration.Bold" />
                        <Markup Content="Grades" Foreground="@Color.Gold3_1" Decoration="Decoration.Bold" />

                        @foreach (var kvp in gradesBySubject)
                        {
                            <Markup Content="@kvp.Key" Foreground="@Color.White" />
                            <Markup Content="@string.Join(", ", kvp.Value.Select(g => g.Value.ToString("F2")))" Foreground="@Color.White" />
                        }
                    </Grid>
                }
            </Rows>
        </Align>
    </Panel>

    <Newline />

    <Panel Title="Actions" Border="BoxBorder.Rounded" Expand="true">
        <Align Horizontal="HorizontalAlignment.Center" Vertical="VerticalAlignment.Middle">
            <Rows>
                <TextButton Content="Add Grade"
                           OnClick="GoToAddGrade"
                           BackgroundColor="@Color.Green"
                           FocusedColor="@Color.LightGreen" />
                <TextButton Content="Back"
                           OnClick="ReturnToClasses"
                           BackgroundColor="@Color.Grey"
                           FocusedColor="@Color.White" />
            </Rows>
        </Align>
    </Panel>
}

@code {
    [Parameter]
    public Guid UserId { get; set; }

    [Parameter]
    public Guid StudentId { get; set; }

    private bool IsLoading = true;
    private bool IsAuthenticated = false;
    private string ErrorMessage = string.Empty;
    private AppUser? CurrentUser;
    private AppUserEnum UserRole = AppUserEnum.Student;
    private AppUser? Student;

    // Temp DI fix
    private AccountService GetAccountService()
    {
        var dbContext = new ApplicationDbContext();
        return new AccountService(dbContext);
    }

    private StudentService GetStudentService()
    {
        var dbContext = new ApplicationDbContext();
        return new StudentService(dbContext);
    }

    protected override void OnInitialized()
    {
        AuthenticateUser();
    }

    private void AuthenticateUser()
    {
        IsLoading = true;
        IsAuthenticated = false;
        ErrorMessage = string.Empty;

        try
        {
            var accountService = GetAccountService();

            var userResult = accountService.GetUserById(UserId);

            if (!userResult.IsSuccess || userResult.Data == null)
            {
                IsAuthenticated = false;
                ErrorMessage = userResult.Message ?? "User not found. Please log in.";
                IsLoading = false;
                return;
            }

            CurrentUser = userResult.Data;

            var roleResult = accountService.GetUserTypeById(UserId);

            if (roleResult.IsSuccess && roleResult.Data != null)
            {
                UserRole = roleResult.Data;
            }
            else
            {
                UserRole = CurrentUser.UserType;
            }

            IsAuthenticated = true;
            LoadStudentData();
        }
        catch (Exception ex)
        {
            IsAuthenticated = false;
            ErrorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }

    private void LoadStudentData()
    {
        try
        {
            var studentService = GetStudentService();
            var studentResult = studentService.GetStudentById(StudentId);

            if (studentResult.IsSuccess && studentResult.Data != null)
            {
                Student = studentResult.Data;
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error loading student data: {ex.Message}";
        }
    }

    private void GoToAddGrade()
    {
        Navigation.NavigateTo($"/Teacher/AddGrade/{UserId}");
    }

    private void ReturnToClasses()
    {
        Navigation.NavigateTo($"/authenticated/Classes/{UserId}");
    }

    private void ReturnToDashboard()
    {
        Navigation.NavigateTo($"/Dashboard/{UserId}");
    }

    /// <summary>
    /// Checks if the current user has a specific role
    /// </summary>
    /// <param name="role">The role to check</param>
    /// <returns>True if user has the role, false otherwise</returns>
    protected bool HasRole(AppUserEnum role)
    {
        return UserRole == role;
    }

    private void ReturnToHome()
    {
        Navigation.NavigateTo("/");
    }
}

