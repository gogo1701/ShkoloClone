@namespace Counter.Components
@using RazorConsole.Components
@inject NavigationManager Navigation
@using Spectre.Console
@using ShkoloClone.Services
@using ShkoloClone.Data
@using ShkoloClone.Models
@using ShkoloClone.Enums
@page "/authenticated/{UserId:guid}"

<Figlet Content="Authenticated Page" />
<Newline />

@if (IsLoading)
{
    <Panel Title="Loading" Border="BoxBorder.Rounded" Expand="true">
        <Align Horizontal="HorizontalAlignment.Center" Vertical="VerticalAlignment.Middle">
            <Markup Content="Loading user information..." Foreground="@Color.Grey70"/>
        </Align>
    </Panel>
}
else if (!IsAuthenticated)
{
    <Panel Title="Access Denied" Border="BoxBorder.Rounded" Expand="true">
        <Align Horizontal="HorizontalAlignment.Center" Vertical="VerticalAlignment.Middle">
            <Rows>
                <Markup Content="@ErrorMessage" Foreground="@Color.Red"/>
                <Newline/>
                <TextButton Content="Back to Home"
                            OnClick="ReturnToHome"
                            BackgroundColor="@Color.Green"
                            FocusedColor="@Color.LightGreen" />
            </Rows>
        </Align>
    </Panel>
}
else
{
    <Panel Title="User Dashboard" Border="BoxBorder.Rounded" Expand="true">
        <Align Horizontal="HorizontalAlignment.Center" Vertical="VerticalAlignment.Middle">
            <Rows>
                <Markup Content="Welcome!" Foreground="@Color.Grey70"/>
                <Newline/>
                <Markup Content="@($"User ID: {UserId}")" Foreground="@Color.White"/>
                <Markup Content="@($"Username: {CurrentUser?.Username ?? "N/A"}")" Foreground="@Color.White"/>
                <Markup Content="@($"Role: {UserRole}")" Foreground="@GetRoleColor()"/>
                <Newline/>
                
                @* Role-based content *@
                @if (UserRole == AppUserEnum.Student)
                {
                    <Markup Content="Student Dashboard" Foreground="@Color.Blue"/>
                    <Newline/>
                    <TextButton Content="View My Grades"
                                OnClick="ViewGrades"
                                BackgroundColor="@Color.Blue"
                                FocusedColor="@Color.LightSkyBlue1"/>
                }
                else if (UserRole == AppUserEnum.Teacher)
                {
                    <Markup Content="Teacher Dashboard" Foreground="@Color.Green"/>
                    <Newline/>
                    <TextButton Content="Manage Classes"
                                OnClick="ManageClasses"
                                BackgroundColor="@Color.Green"
                                FocusedColor="@Color.LightGreen"/>
                    <TextButton Content="Add Grades"
                                OnClick="AddGrades"
                                BackgroundColor="@Color.Green"
                                FocusedColor="@Color.LightGreen"/>
                }
                else if (UserRole == AppUserEnum.Admin)
                {
                    <Markup Content="Admin Dashboard" Foreground="@Color.Yellow"/>
                    <Newline/>
                    <TextButton Content="Manage Users"
                                OnClick="ManageUsers"
                                BackgroundColor="@Color.Yellow"
                                FocusedColor="@Color.LightYellow3"/>
                    <TextButton Content="System Settings"
                                OnClick="SystemSettings"
                                BackgroundColor="@Color.Yellow"
                                FocusedColor="@Color.LightYellow3" />
                }
                
                <Newline/>
                <TextButton Content="Back to Home"
                            OnClick="ReturnToHome"
                            BackgroundColor="@Color.Grey"
                            FocusedColor="@Color.White"/>
            </Rows>
        </Align>
    </Panel>
}

<Newline />
<Markup Content="Press Tab to change focus • Press Enter to click • Press Ctrl+C to exit" Foreground="@Color.Grey58" />

@code {
    [Parameter]
    public Guid UserId { get; set; }

    private bool IsLoading = true;
    private bool IsAuthenticated = false;
    private string ErrorMessage = string.Empty;
    private AppUser? CurrentUser;
    private AppUserEnum UserRole = AppUserEnum.Student;

    // Temp DI fix
    private AccountService GetAccountService()
    {
        var dbContext = new ApplicationDbContext();
        return new AccountService(dbContext);
    }

    protected override void OnInitialized()
    {
        AuthenticateUser();
    }

    private void AuthenticateUser()
    {
        IsLoading = true;
        IsAuthenticated = false;
        ErrorMessage = string.Empty;

        try
        {
            var accountService = GetAccountService();
            
            var userResult = accountService.GetUserById(UserId);
            
            if (!userResult.IsSuccess || userResult.Data == null)
            {
                IsAuthenticated = false;
                ErrorMessage = userResult.Message ?? "User not found. Please log in.";
                IsLoading = false;
                return;
            }

            CurrentUser = userResult.Data;

            var roleResult = accountService.GetUserTypeById(UserId);
            
            if (roleResult.IsSuccess && roleResult.Data != null)
            {
                UserRole = roleResult.Data;
            }
            else
            {
                UserRole = CurrentUser.UserType;
            }

            IsAuthenticated = true;
        }
        catch (Exception ex)
        {
            IsAuthenticated = false;
            ErrorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }

    private Color GetRoleColor()
    {
        return UserRole switch
        {
            AppUserEnum.Student => Color.Blue,
            AppUserEnum.Teacher => Color.Green,
            AppUserEnum.Admin => Color.Yellow,
            _ => Color.White
        };
    }

    private bool HasRole(AppUserEnum role)
    {
        return UserRole == role;
    }

    private void ViewGrades()
    {
        // Navigate to grades page for student
        Navigation.NavigateTo($"/grades/{UserId}");
    }

    private void ManageClasses()
    {
        // Navigate to classes management for teacher
        Navigation.NavigateTo($"/classes/{UserId}");
    }

    private void AddGrades()
    {
        // Navigate to add grades page for teacher
        Navigation.NavigateTo($"/grades/add/{UserId}");
    }

    private void ManageUsers()
    {
        // Navigate to user management for admin
        Navigation.NavigateTo($"/admin/users/{UserId}");
    }

    private void SystemSettings()
    {
        // Navigate to system settings for admin
        Navigation.NavigateTo($"/admin/settings/{UserId}");
    }

    private void ReturnToHome()
    {
        Navigation.NavigateTo("/");
    }
}

