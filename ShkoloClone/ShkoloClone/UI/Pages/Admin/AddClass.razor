@* This is an authenticated page. Copy this for other pages that need authentication and authorization.*@

@namespace Counter.Components
@using RazorConsole.Components
@inject NavigationManager Navigation
@using Spectre.Console
@using ShkoloClone.Services
@using ShkoloClone.Data
@using ShkoloClone.Models
@using ShkoloClone.Enums
@page "/Admin/SchoolSettings/AddClass/{UserId:guid}"

@if (IsLoading)
{
    <Panel Title="Loading" Border="BoxBorder.Rounded" Expand="true">
        <Align Horizontal="HorizontalAlignment.Center" Vertical="VerticalAlignment.Middle">
            <Markup Content="Loading user information..." Foreground="@Color.Grey70"/>
        </Align>
    </Panel>
}
else if (!IsAuthenticated)
{
    <Panel Title="Access Denied" Border="BoxBorder.Rounded" Expand="true">
        <Align Horizontal="HorizontalAlignment.Center" Vertical="VerticalAlignment.Middle">
            <Rows>
                <Markup Content="@ErrorMessage" Foreground="@Color.Red"/>
                <Newline/>
                <TextButton Content="Back to Home"
                            OnClick="ReturnToHome"
                            BackgroundColor="@Color.Green"
                            FocusedColor="@Color.LightGreen" />
            </Rows>
        </Align>
    </Panel>
}
else
{
    <Figlet Content="Add Class"/>
    <Panel Title="Add Class" Border="BoxBorder.Rounded" Expand="true">
        <Align Horizontal="HorizontalAlignment.Center" Vertical="VerticalAlignment.Middle">
            <Rows>
                @if (!string.IsNullOrEmpty(Message))
                {
                    <Markup Content="@Message" Foreground="@(IsError ? Color.Red : Color.Green)" />
                    <Newline />
                }
                
                <Markup Content="Class Name:" Foreground="@Color.Grey70" />
                <TextInput Content="@ClassName"
                           ValueChanged="@((v) => ClassName = v)"
                           Placeholder="Enter class name (e.g., Grade 5A, Math 101)" />
                <Newline />
                
                <Markup Content="Select Teacher:" Foreground="@Color.Grey70" />
                <Select Options="@TeacherNames.ToArray()"
                        @bind-Value="SelectedTeacher"
                        Placeholder="Select a teacher" />
                <Newline />
                
                <Markup Content="Add Students:" Foreground="@Color.Grey70" />
                @for (int i = 0; i < StudentSelections.Count; i++)
                {
                    <Select Options="@StudentOptions.ToArray()"
                            @bind-Value="StudentSelections[i]"
                            Placeholder="Select student" />
                }

                <TextButton Content="Add Another Student"
                            OnClick="AddStudentSlot"
                            BackgroundColor="@Color.Blue"
                            FocusedColor="@Color.LightSkyBlue1" />
                <Newline />

                <TextButton Content="Create Class" 
                            BackgroundColor="@Color.Green" 
                            FocusedColor="@Color.LightGreen"
                            OnClick="SaveClass"/>
                <Newline />
                <TextButton Content="Back to School Settings"
                            OnClick="ReturnToSchoolSettings"
                            BackgroundColor="@Color.Grey"
                            FocusedColor="@Color.White" />
                <TextButton Content="Back to Dashboard"
                            OnClick="ReturnToDashboard"
                            BackgroundColor="@Color.Blue"
                            FocusedColor="@Color.LightSkyBlue1" />
            </Rows>
        </Align>
    </Panel>
}

@code {
    [Parameter]
    public Guid UserId { get; set; }

    private bool IsLoading = true;
    private bool IsAuthenticated = false;
    private string ErrorMessage = string.Empty;
    private AppUser? CurrentUser;
    private AppUserEnum UserRole = AppUserEnum.Student;

    // Temp DI fix
    private AccountService GetAccountService()
    {
        var dbContext = new ApplicationDbContext();
        return new AccountService(dbContext);
    }

    private TeacherService GetTeacherService()
    {
        var dbContext = new ApplicationDbContext();
        return new TeacherService(dbContext);
    }
    private ClassService GetClassService()
    {
        var dbContext = new ApplicationDbContext();
        return new ClassService(dbContext);
    }
    private StudentService GetStudentService()
    {
        var dbContext = new ApplicationDbContext();
        return new StudentService(dbContext);
    }

    private List<string> TeacherNames = new();
    private List<string> StudentOptions = new();
    private List<string> StudentSelections = new();

    private string? SelectedTeacher;
    private string ClassName = string.Empty;
    private string Message = string.Empty;
    private bool IsError = false;


    protected override void OnInitialized()
    {
        AuthenticateUser();
        LoadStudents();
        StudentSelections.Add("");

        if (IsAuthenticated)
            LoadTeachers();
    }

    private void LoadStudents()
    {
        var studentService = GetStudentService();
        var studentsResult = studentService.GetAllStudents(); 

        StudentOptions = studentsResult
            .Select(s => $"{s.Id} - {s.FirstName} {s.LastName}")
            .ToList();
        
    }

    private void AddStudentSlot()
    {
        StudentSelections.Add("");
    }

    private void LoadTeachers()
    {
        var teacherService = GetTeacherService();
        var teachers = teacherService.GetAllTeachers();

        TeacherNames = teachers
            .Select(t => $"{t.Id} - {t.FirstName} {t.LastName}")
            .ToList();
    }

    private void SaveClass()
    {
        Message = string.Empty;
        IsError = false;

        if (string.IsNullOrWhiteSpace(ClassName))
        {
            Message = "Please enter a class name.";
            IsError = true;
            return;
        }

        if (string.IsNullOrWhiteSpace(SelectedTeacher))
        {
            Message = "Please select a teacher.";
            IsError = true;
            return;
        }

        try
        {
            var teacherId = SelectedTeacher.Split(" - ")[0];

            var studentIds = StudentSelections
                .Where(x => !string.IsNullOrWhiteSpace(x))
                .Select(x => Guid.Parse(x.Split(" - ")[0]))
                .ToList();

            var classService = GetClassService();
            var result = classService.CreateClass(ClassName, Guid.Parse(teacherId), studentIds);

            if (result.IsSuccess)
            {
                Message = $"Class '{ClassName}' created successfully! Click 'Back to School Settings' to return.";
                IsError = false;
                // Clear form
                ClassName = string.Empty;
                SelectedTeacher = null;
                StudentSelections.Clear();
                StudentSelections.Add("");
            }
            else
            {
                Message = result.Message;
                IsError = true;
            }
        }
        catch (Exception ex)
        {
            Message = $"An error occurred: {ex.Message}";
            IsError = true;
        }
    }

    private void ReturnToSchoolSettings()
    {
        Navigation.NavigateTo($"/Admin/SchoolSettings/{UserId}");
    }

    private void ReturnToDashboard()
    {
        Navigation.NavigateTo($"/Dashboard/{UserId}");
    }

    private void AuthenticateUser()
    {
        IsLoading = true;
        IsAuthenticated = false;
        ErrorMessage = string.Empty;

        try
        {
            var accountService = GetAccountService();
            
            var userResult = accountService.GetUserById(UserId);
            
            if (!userResult.IsSuccess || userResult.Data == null)
            {
                IsAuthenticated = false;
                ErrorMessage = userResult.Message ?? "User not found. Please log in.";
                IsLoading = false;
                return;
            }

            CurrentUser = userResult.Data;

            var roleResult = accountService.GetUserTypeById(UserId);
            
            if (roleResult.IsSuccess && roleResult.Data != null)
            {
                UserRole = roleResult.Data;
            }
            else
            {
                UserRole = CurrentUser.UserType;
            }

            IsAuthenticated = true;
        }
        catch (Exception ex)
        {
            IsAuthenticated = false;
            ErrorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }

    /// <summary>
    /// Checks if the current user has a specific role
    /// </summary>
    /// <param name="role">The role to check</param>
    /// <returns>True if user has the role, false otherwise</returns>
    protected bool HasRole(AppUserEnum role)
    {
        return UserRole == role;
    }

    /// <summary>
    /// Gets the color associated with a role
    /// </summary>
    /// <param name="role">The role</param>
    /// <returns>Color for the role</returns>
    protected Color GetRoleColor(AppUserEnum role)
    {
        return role switch
        {
            AppUserEnum.Student => Color.Blue,
            AppUserEnum.Teacher => Color.Green,
            AppUserEnum.Admin => Color.Red,
            _ => Color.White
        };
    }

    /// <summary>
    /// Gets the color for the current user's role
    /// </summary>
    /// <returns>Color for the current user's role</returns>
    protected Color GetCurrentRoleColor()
    {
        return GetRoleColor(UserRole);
    }

    private void ReturnToHome()
    {
        Navigation.NavigateTo("/");
    }
}

