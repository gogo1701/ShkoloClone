@* This is an authenticated page. Copy this for other pages that need authentication and authorization.*@

@namespace Counter.Components
@using RazorConsole.Components
@inject NavigationManager Navigation
@using Spectre.Console
@using ShkoloClone.Services
@using ShkoloClone.Data
@using ShkoloClone.Models
@using ShkoloClone.Enums
@page "/Admin/ManageUsers/{UserId:guid}"

@if (IsLoading)
{
    <Panel Title="Loading" Border="BoxBorder.Rounded" Expand="true">
        <Align Horizontal="HorizontalAlignment.Center" Vertical="VerticalAlignment.Middle">
            <Markup Content="Loading user information..." Foreground="@Color.Grey70" />
        </Align>
    </Panel>
}
else if (!IsAuthenticated)
{
    <Panel Title="Access Denied" Border="BoxBorder.Rounded" Expand="true">
        <Align Horizontal="HorizontalAlignment.Center" Vertical="VerticalAlignment.Middle">
            <Rows>
                <Markup Content="@ErrorMessage" Foreground="@Color.Red" />
                <Newline />
                <TextButton Content="Back to Home"
                            OnClick="ReturnToHome"
                            BackgroundColor="@Color.Green"
                            FocusedColor="@Color.LightGreen" />
            </Rows>
        </Align>
    </Panel>
}
else if (!HasRole(AppUserEnum.Admin))
{
    <Panel Title="Access Denied" Border="BoxBorder.Rounded" Expand="true">
        <Align Horizontal="HorizontalAlignment.Center" Vertical="VerticalAlignment.Middle">
            <Rows>
                <Markup Content="Only administrators can access this page." Foreground="@Color.Red" />
                <Newline />
                <TextButton Content="Back"
                            OnClick="ReturnToAuthenticated"
                            BackgroundColor="@Color.Green"
                            FocusedColor="@Color.LightGreen" />
            </Rows>
        </Align>
    </Panel>
}
else
{
    <Figlet Content="Manage Roles" />
    <Newline />

    <Panel Title="Teachers and Admins" Border="BoxBorder.Rounded" Expand="true">
        <Align Horizontal="HorizontalAlignment.Center" Vertical="VerticalAlignment.Middle">
            <Rows>
                <Markup Content="Current Teachers and Administrators" Foreground="@Color.Grey70" />
                <Newline />
                @if (TeachersAndAdmins.Count == 0)
                {
                    <Markup Content="No teachers or administrators found." Foreground="@Color.Yellow" />
                }
                else
                {
                    @foreach (var user in TeachersAndAdmins)
                    {
                        <Markup Content="@($"{user.Username} - {user.UserType}")" Foreground="@GetRoleColor(user.UserType)" />
                    }
                }
            </Rows>
        </Align>
    </Panel>

    <Newline />

    <Panel Title="Add Teacher/Admin" Border="BoxBorder.Rounded" Expand="true">
        <Align Horizontal="HorizontalAlignment.Center" Vertical="VerticalAlignment.Middle">
            <Rows>
                <Markup Content="Assign role to user by username" Foreground="@Color.Grey70" />
                <Newline />
                @if (!string.IsNullOrEmpty(AddRoleMessage))
                {
                    <Markup Content="@AddRoleMessage" Foreground="@(AddRoleIsError? Color.Red: Color.Green)" />
                    <Newline />
                }
                <TextInput Content="@UsernameToAdd"
                           ValueChanged="@((v) => UsernameToAdd = v)"
                           Placeholder="Enter username" />
                <Newline />
                <Markup Content="Select role:" Foreground="@Color.Grey70" />
                <Select Options="@RoleOptions" 
                        Value="@SelectedRoleString" 
                        ValueChanged="@OnRoleSelected" 
                        Expand="true" />
                <Newline />
                <TextButton Content="Assign Role"
                            OnClick="AssignRoleToUser"
                            BackgroundColor="@Color.Blue"
                            FocusedColor="@Color.LightSkyBlue1" />
            </Rows>
        </Align>
    </Panel>

    <Newline />
    <TextButton Content="Back"
                OnClick="ReturnToAuthenticated"
                BackgroundColor="@Color.Grey"
                FocusedColor="@Color.White" />
}

<Newline />
<Markup Content="Press Tab to change focus � Press Enter to click � Press Ctrl+C to exit" Foreground="@Color.Grey58" />

@code {
    [Parameter]
    public Guid UserId { get; set; }

    private bool IsLoading = true;
    private bool IsAuthenticated = false;
    private string ErrorMessage = string.Empty;
    private AppUser? CurrentUser;
    private AppUserEnum UserRole = AppUserEnum.Student;

    private List<AppUser> TeachersAndAdmins = new();
    private string UsernameToAdd = string.Empty;
    private AppUserEnum SelectedRole = AppUserEnum.Teacher;
    private string SelectedRoleString = "Teacher";
    private string[] RoleOptions = new[] { "Teacher", "Admin" };
    private string AddRoleMessage = string.Empty;
    private bool AddRoleIsError = false;

    // Temp DI fix
    private AccountService GetAccountService()
    {
        var dbContext = new ApplicationDbContext();
        return new AccountService(dbContext);
    }

    protected override void OnInitialized()
    {
        AuthenticateUser();
    }

    private void AuthenticateUser()
    {
        IsLoading = true;
        IsAuthenticated = false;
        ErrorMessage = string.Empty;

        try
        {
            var accountService = GetAccountService();

            var userResult = accountService.GetUserById(UserId);

            if (!userResult.IsSuccess || userResult.Data == null)
            {
                IsAuthenticated = false;
                ErrorMessage = userResult.Message ?? "User not found. Please log in.";
                IsLoading = false;
                return;
            }

            CurrentUser = userResult.Data;

            var roleResult = accountService.GetUserTypeById(UserId);

            if (roleResult.IsSuccess && roleResult.Data != null)
            {
                UserRole = roleResult.Data;
            }
            else
            {
                UserRole = CurrentUser.UserType;
            }

            IsAuthenticated = true;
            LoadTeachersAndAdmins();
        }
        catch (Exception ex)
        {
            IsAuthenticated = false;
            ErrorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }

    private void LoadTeachersAndAdmins()
    {
        try
        {
            var accountService = GetAccountService();
            var allUsers = accountService.GetAllUsers();

            TeachersAndAdmins = allUsers
                .Where(u => u.UserType == AppUserEnum.Teacher || u.UserType == AppUserEnum.Admin)
                .ToList();
        }
        catch (Exception ex)
        {
            // Handle error silently or show message
        }
    }

    private void OnRoleSelected(string selectedValue)
    {
        SelectedRoleString = selectedValue;
        SelectedRole = selectedValue == "Teacher" ? AppUserEnum.Teacher : AppUserEnum.Admin;
    }

    private void AssignRoleToUser()
    {
        AddRoleMessage = string.Empty;
        AddRoleIsError = false;

        if (string.IsNullOrWhiteSpace(UsernameToAdd))
        {
            AddRoleMessage = "Please enter a username.";
            AddRoleIsError = true;
            return;
        }

        try
        {
            var accountService = GetAccountService();
            var userResult = accountService.GetUserByUsername(UsernameToAdd);

            if (!userResult.IsSuccess || userResult.Data == null)
            {
                AddRoleMessage = userResult.Message ?? "User not found.";
                AddRoleIsError = true;
                return;
            }

            var user = userResult.Data;
            user.UserType = SelectedRole;

            var dbContext = new ApplicationDbContext();
            var userToUpdate = dbContext.Users.FirstOrDefault(u => u.Id == user.Id);

            if (userToUpdate != null)
            {
                userToUpdate.UserType = SelectedRole;
                dbContext.SaveChanges();

                AddRoleMessage = $"Successfully assigned {SelectedRole} role to {UsernameToAdd}.";
                AddRoleIsError = false;
                UsernameToAdd = string.Empty;
                LoadTeachersAndAdmins();
            }
            else
            {
                AddRoleMessage = "Error updating user role.";
                AddRoleIsError = true;
            }
        }
        catch (Exception ex)
        {
            AddRoleMessage = $"An error occurred: {ex.Message}";
            AddRoleIsError = true;
        }
    }

    /// <summary>
    /// Checks if the current user has a specific role
    /// </summary>
    /// <param name="role">The role to check</param>
    /// <returns>True if user has the role, false otherwise</returns>
    protected bool HasRole(AppUserEnum role)
    {
        return UserRole == role;
    }

    /// <summary>
    /// Gets the color associated with a role
    /// </summary>
    /// <param name="role">The role</param>
    /// <returns>Color for the role</returns>
    protected Color GetRoleColor(AppUserEnum role)
    {
        return role switch
        {
            AppUserEnum.Student => Color.Blue,
            AppUserEnum.Teacher => Color.Green,
            AppUserEnum.Admin => Color.Red,
            _ => Color.White
        };
    }

    private void ReturnToAuthenticated()
    {
        Navigation.NavigateTo($"/Dashboard/{UserId}");
    }

    private void ReturnToHome()
    {
        Navigation.NavigateTo("/");
    }
}

