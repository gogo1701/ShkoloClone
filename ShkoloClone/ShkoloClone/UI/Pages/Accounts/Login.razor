@namespace Counter.Components
@using RazorConsole.Components
@inject NavigationManager Navigation
@using Spectre.Console
@using ShkoloClone.Services
@using ShkoloClone.Data
@page "/Login"

<Figlet Content="Login" />
<Newline />

<Panel Title="Account" Border="BoxBorder.Rounded" Expand="true">
    <Align Horizontal="HorizontalAlignment.Center" Vertical="VerticalAlignment.Middle">
        <Rows>
            <Markup Content="Login" Foreground="@Color.Grey70"/>
            <Newline/>
            @if (!string.IsNullOrEmpty(Message))
            {
                <Markup Content="@Message" Foreground="@(IsError ? Color.Red : Color.Green)"/>
                <Newline/>
            }
            <TextInput Content="@UserName"
                       ValueChanged="@((v) => UserName = v)"
                       Placeholder="Enter your username"/>
            <Newline/>
            <TextInput Content="@Password"
                       ValueChanged="@((v) => Password = v)"
                       Placeholder="Enter your password"/>
            <Newline/>
            <TextButton Content="Login"
                        OnClick="LoginButton"
                        BackgroundColor="@Color.Blue"
                        FocusedColor="@Color.LightSkyBlue1"/>
            <Newline/>
            <TextButton Content="Back to Home"
                        OnClick="Return"
                        BackgroundColor="@Color.Green"
                        FocusedColor="@Color.LightGreen" />
        </Rows>
    </Align>
</Panel>

<Newline />
<Markup Content="Press Tab to change focus • Press Enter to click • Press Ctrl+C to exit" Foreground="@Color.Grey58" />

@code {
    string UserName = string.Empty;
    string Password = string.Empty;
    string Message = string.Empty;
    bool IsError = false;

    //  temp DI fix
    private AccountService GetAccountService()
    {
        var dbContext = new ApplicationDbContext();
        return new AccountService(dbContext);
    }

    private void LoginButton()
    {
        Message = string.Empty;
        IsError = false;

        if (string.IsNullOrWhiteSpace(UserName) || string.IsNullOrWhiteSpace(Password))
        {
            Message = "Please enter both username and password.";
            IsError = true;
            return;
        }

        var accountService = GetAccountService();
        var result = accountService.LoginUser(UserName, Password);

        if (result.IsSuccess)
        {
            Message = result.Message;
            IsError = false;

            if (result.Data != null)
            {
                Navigation.NavigateTo($"/authenticated/{result.Data}");
            }
            else
            {
                Navigation.NavigateTo("/");
            }
        }
        else
        {
            Message = result.Message;
            IsError = true;
        }
    }

    private void Return()
    {
        Navigation.NavigateTo("/");
    }

}