@namespace Counter.Components
@using RazorConsole.Components
@inject NavigationManager Navigation
@using Spectre.Console
@using ShkoloClone.Services
@using ShkoloClone.Data
@using ShkoloClone.Models
@using ShkoloClone.Enums
@using Spinner = Spectre.Console.Spinner
@page "/Dashboard/{UserId:guid}"

@if (IsLoading)
{
    <Panel Title="Loading" Border="BoxBorder.Rounded" Expand="true">
        <Align Horizontal="HorizontalAlignment.Center" Vertical="VerticalAlignment.Middle">
            <Markup Content="Loading user information..." Foreground="@Color.Grey70"/>
        </Align>
    </Panel>
}
else if (!IsAuthenticated)
{
    <Panel Title="Access Denied" Border="BoxBorder.Rounded" Expand="true">
        <Align Horizontal="HorizontalAlignment.Center" Vertical="VerticalAlignment.Middle">
            <Rows>
                <Markup Content="@ErrorMessage" Foreground="@Color.Red"/>
                <Newline/>
                <TextButton Content="Back to Home"
                            OnClick="ReturnToHome"
                            BackgroundColor="@Color.Green"
                            FocusedColor="@Color.LightGreen" />
            </Rows>
        </Align>
    </Panel>
}
else
{
    @if (HasRole(AppUserEnum.Student))
    {
        <Figlet Content="Student Dashboard" />
        <Panel Title="Student Dashboard" Border="BoxBorder.Rounded" Expand="true">
            <Align Horizontal="HorizontalAlignment.Center" Vertical="VerticalAlignment.Middle">
                <Rows>
                    <Markup Content="@GetNameFullString()" Foreground="Color.Gold3_1" Decoration="Decoration.Bold"/>
                    <Newline/>
                    <Markup Content="Please select one of the options." Foreground="Color.White" Decoration="Decoration.Bold"/>
                    <Spinner SpinnerType="Spinner.Known.BouncingBar"></Spinner>
                    <TextButton Content="View All Grades" BackgroundColor="Color.Green" OnClick="ViewGradesButton"/>
                    <TextButton Content="View User Details" BackgroundColor="@GetCurrentRoleColor()" OnClick="GoToDetails"></TextButton>
                    <TextButton Content="Logout" BackgroundColor="Color.Red" OnClick="ReturnToHome"/>

                </Rows>
            </Align>
        </Panel>
    }
    else if (HasRole(AppUserEnum.Teacher))
    {
        <Figlet Content="Teacher Dashboard" />
        <Panel Title="Teacher Dashboard" Border="BoxBorder.Rounded" Expand="true">
            <Align Horizontal="HorizontalAlignment.Center" Vertical="VerticalAlignment.Middle">
                <Rows>
                    <Markup Content="@GetNameFullString()" Foreground="Color.Gold3_1" Decoration="Decoration.Bold"/>
                    <Newline/>
                    <Markup Content="Please select one of the options." Foreground="Color.White" Decoration="Decoration.Bold"/>
                    <Spinner SpinnerType="Spinner.Known.BouncingBar"></Spinner>
                    <TextButton Content="View My Classes" BackgroundColor="@GetCurrentRoleColor()" OnClick="GoToClasses"/>
                    <TextButton Content="Add Grade" BackgroundColor="Color.Green" OnClick="GoToAddGrade"/>
                    <TextButton Content="View User Details" BackgroundColor="@GetCurrentRoleColor()" OnClick="GoToDetails"></TextButton>
                    <TextButton Content="Logout" BackgroundColor="Color.Red" OnClick="ReturnToHome"/>

                </Rows>
            </Align>
        </Panel>
    }
    else if (HasRole(AppUserEnum.Admin))
    {
        <Figlet Content="Student Dashboard" />
        <Panel Title="Admin Dashboard" Border="BoxBorder.Rounded" Expand="true">
            <Align Horizontal="HorizontalAlignment.Center" Vertical="VerticalAlignment.Middle">
                <Rows>
                    <Markup Content="@GetNameFullString()" Foreground="Color.Gold3_1" Decoration="Decoration.Bold"/>
                    <Newline/>
                    <Markup Content="Please select one of the options." Foreground="Color.White" Decoration="Decoration.Bold"/>
                    <Spinner SpinnerType="Spinner.Known.BouncingBar"></Spinner>
                    <TextButton Content="Manage Roles" BackgroundColor="@GetCurrentRoleColor()" OnClick="GoToManageRoles" />
                    <TextButton Content="School Settings" BackgroundColor="@GetCurrentRoleColor()" OnClick="GoToSchoolSettings"/>
                    <TextButton Content="Logout" BackgroundColor="Color.Red" OnClick="ReturnToHome"/>

                </Rows>
            </Align>
        </Panel>
    }
}

@code {
    [Parameter]
    public Guid UserId { get; set; }

    private bool IsLoading = true;
    private bool IsAuthenticated = false;
    private string ErrorMessage = string.Empty;
    private AppUser? CurrentUser;
    private AppUserEnum UserRole = AppUserEnum.Student;

    // Temp DI fix
    private AccountService GetAccountService()
    {
        var dbContext = new ApplicationDbContext();
        return new AccountService(dbContext);
    }

    private GradeService GetGradeService()
    {
        var dbContext = new ApplicationDbContext();
        return new GradeService(dbContext);
    }

    private TeacherService GetTeacherService()
    {
        var dbContext = new ApplicationDbContext();
        return new TeacherService(dbContext);
    }

    private StudentService GetStudentService()
    {
        var dbContext = new ApplicationDbContext();
        return new StudentService(dbContext);
    }

    private ClassService GetClassService()
    {
        var dbContext = new ApplicationDbContext();
        return new ClassService(dbContext);
    }

    private string GetUsername() => GetAccountService().GetUserById(UserId).Data.Username;

    private string GetName()
    {
        var user = GetAccountService().GetUserById(UserId).Data;
        return $"{user.FirstName} {user.LastName}";
    }
    private string GetNameFullString()
    {
        return $"Hello {GetName()}!";
    }

    private void ViewGradesButton()
    {
        Navigation.NavigateTo($"/Student/ViewGrades/{UserId}");
    }


    protected override void OnInitialized()
    {
        AuthenticateUser();
    }

    private void AuthenticateUser()
    {
        IsLoading = true;
        IsAuthenticated = false;
        ErrorMessage = string.Empty;

        try
        {
            var accountService = GetAccountService();
            
            var userResult = accountService.GetUserById(UserId);
            
            if (!userResult.IsSuccess || userResult.Data == null)
            {
                IsAuthenticated = false;
                ErrorMessage = userResult.Message ?? "User not found. Please log in.";
                IsLoading = false;
                return;
            }

            CurrentUser = userResult.Data;

            var roleResult = accountService.GetUserTypeById(UserId);
            
            if (roleResult.IsSuccess && roleResult.Data != null)
            {
                UserRole = roleResult.Data;
            }
            else
            {
                UserRole = CurrentUser.UserType;
            }

            IsAuthenticated = true;
        }
        catch (Exception ex)
        {
            IsAuthenticated = false;
            ErrorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }

    /// <summary>
    /// Checks if the current user has a specific role
    /// </summary>
    /// <param name="role">The role to check</param>
    /// <returns>True if user has the role, false otherwise</returns>
    protected bool HasRole(AppUserEnum role)
    {
        return UserRole == role;
    }

    /// <summary>
    /// Gets the color associated with a role
    /// </summary>
    /// <param name="role">The role</param>
    /// <returns>Color for the role</returns>
    protected Color GetRoleColor(AppUserEnum role)
    {
        return role switch
        {
            AppUserEnum.Student => Color.Blue,
            AppUserEnum.Teacher => Color.Green,
            AppUserEnum.Admin => Color.Red,
            _ => Color.White
        };
    }

    /// <summary>
    /// Gets the color for the current user's role
    /// </summary>
    /// <returns>Color for the current user's role</returns>
    protected Color GetCurrentRoleColor()
    {
        return GetRoleColor(UserRole);
    }

    private void GoToManageRoles()
    {
        Navigation.NavigateTo($"/Admin/ManageUsers/{UserId}");
    }

    private void GoToSchoolSettings()
    {
        Navigation.NavigateTo($"/Admin/SchoolSettings/{UserId}");
    }

    private void GoToDetails()
    {
        Navigation.NavigateTo($"/Details/{UserId}");
    }

    private void GoToClasses()
    {
        Navigation.NavigateTo($"/authenticated/Classes/{UserId}");
    }

    private void GoToAddGrade()
    {
        Navigation.NavigateTo($"/Teacher/AddGrade/{UserId}");
    }

    private void ReturnToHome()
    {
        Navigation.NavigateTo("/");
    }
}

